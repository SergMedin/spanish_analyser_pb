# Автоматическое определение поля с испанским текстом в Anki карточках

## Проблема

Ранее система предполагала, что испанский текст всегда находится в поле `FrontText`, а перевод в `BackText`. Однако в некоторых карточках может быть наоборот: русский текст в `FrontText`, а испанский в `BackText`. Это приводило к неправильной обработке таких карточек.

## Решение

Реализован алгоритм автоматического определения поля с испанским текстом на основе анализа доли латинских букв и цифр.

### Алгоритм

1. **Очистка текста**: Удаляются HTML теги из обоих полей
2. **Подсчёт букв**: Определяется общее количество букв любого алфавита в тексте
3. **Подсчёт латинских символов**: Считаются латинские буквы (включая диакритики: á, é, í, ó, ú, ñ, ü) и цифры
4. **Вычисление доли**: Доля = латинские_символы / общее_количество_букв
5. **Выбор поля**: Поле с большей долей латинских символов считается содержащим испанский текст

### Код

```python
def _detect_spanish_field(self, front_text: str, back_text: str) -> str:
    """
    Определяет какое поле содержит испанский текст на основе доли латинских букв и цифр.
    
    Returns:
        'front' если испанский текст в FrontText, 'back' если в BackText
    """
```

### Примеры работы

| FrontText | BackText | Результат | Обоснование |
|-----------|----------|-----------|-------------|
| "el coche" | "машина" | 'front' | Латинские буквы только в FrontText |
| "машина" | "el coche" | 'back' | Латинские буквы только в BackText |
| "información" | "информация" | 'front' | Доля латинских в FrontText выше |
| "Урок 5" | "número 5" | 'back' | Учитываются и цифры |
| "&lt;b&gt;la capital&lt;/b&gt;" | "&lt;i&gt;столица&lt;/i&gt;" | 'front' | HTML теги игнорируются |

## Изменения в коде

### AnkiConnector

Файл: `src/spanish_analyser/components/anki_connector.py`

1. **Добавлена функция `_detect_spanish_field()`** - определяет поле с испанским текстом
2. **Обновлён метод `extract_all_spanish_words()`** - использует новый алгоритм вместо жёсткого указания полей
3. **Улучшена отчётность** - более точные сообщения о причинах исключения заметок

### Преимущества

- ✅ **Универсальность**: Работает с любым расположением испанского текста
- ✅ **Надёжность**: Основан на лингвистических особенностях, а не на предположениях
- ✅ **Совместимость**: Не ломает существующую функциональность
- ✅ **Точность**: Учитывает HTML разметку и диакритические знаки

### Ограничения

- Может неправильно определить поле, если в обоих полях схожая доля латинских символов
- Предполагает, что один из языков использует латинский алфавит, а другой — нет

## Тестирование

Алгоритм протестирован на различных типах карточек:
- Стандартные карточки (испанский → русский)
- Обращённые карточки (русский → испанский)  
- Карточки с HTML разметкой
- Карточки с цифрами и смешанным контентом
- Карточки с диакритическими знаками

Все существующие тесты (79 тестов) продолжают успешно проходить.
